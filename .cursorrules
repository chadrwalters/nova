# Nova Document Processor Pipeline Rules

# Core Pipeline Structure
pipeline:
  phases:
    - MARKDOWN_PARSE:
        description: "Parse markdown files using markdown-it"
        output_dir: "01_markdown_parse"
        requirements:
          - Validate input markdown
          - Process with Microsoft markitdown
          - Convert Office formats:
              * Word (.docx, .doc)
              * PowerPoint (.pptx, .ppt)
              * Excel (.xlsx, .xls)
              * PDF (.pdf)
          - Handle code blocks and tables
          - Process GFM extensions
          - Handle image references
          - Extract metadata from:
              * Office documents
              * PDF files
              * Image EXIF data
          - Preserve metadata
          - Save intermediate files to phase directory
        
    - MARKDOWN_CONSOLIDATE:
        description: "Combine markdown content"
        output_dir: "02_markdown_consolidate"
        requirements:
          - Maintain document order
          - Preserve headers
          - Handle cross-references
          - Update internal links
          - Merge metadata
          - Read from previous phase directory
          - Save consolidated output to phase directory
        
    - PDF_GENERATE:
        description: "Generate final PDF using WeasyPrint"
        output_dir: "03_pdf_generate"
        requirements:
          - Apply PDF styling
          - Process images and assets
          - Set metadata
          - Handle page breaks
          - Manage fonts and styling
          - Support Unicode and special characters
          - Read from consolidate phase directory
          - Generate final PDF in output directory

# State Management
state_tracking:
  required_states:
    - current_phase
    - processed_files
    - validation_results
    - resource_usage
    - phase_directories
  persistence:
    - Maintain phase directory structure
    - Keep intermediate files for debugging
    - Clean up old files based on retention policy
    - Track partial results

# Error Handling
error_handling:
  retry_policy:
    max_retries: 3
    delay_between_retries: 1
    backoff_factor: 2
  error_tolerance:
    allow_partial_success: true
    continue_on_non_critical: true
  cleanup:
    - Remove temporary files
    - Free resources

# Resource Management
resource_management:
  file_operations:
    - Use pathlib.Path exclusively
    - Implement proper locking
    - Clean up temporary files
  memory:
    - Monitor WeasyPrint memory usage
    - Implement memory limits
    - Clean up regularly
  disk:
    - Track space usage
    - Maintain cleanup schedule
    - Handle large files
  logging_rules:
    - filter_binary_content: true
    - summarize_large_data: true
    - exclude_base64_from_console: true

# Validation
validation:
  input:
    - File existence
    - Markdown structure
    - Encoding
    - Size limits
    - Content preservation
    - Business context retention
    - Personnel information accuracy
    - Decision record completeness
  output:
    - PDF structure
    - Image quality
    - Metadata presence
    - Font embedding
    - Unicode support

# Code Quality
code_quality:
  style:
    - Use black formatter
    - Follow PEP 8
    - Maximum line length: 88
  typing:
    - Use type hints
    - Enable strict mypy
    - Document type aliases
  documentation:
    - Google style docstrings
    - Update README.md
    - Maintain CHANGELOG.md

# Testing Requirements
testing:
  coverage:
    minimum: 80%
  types:
    - Unit tests
    - Integration tests
    - Performance tests
    - Concurrency tests
  scenarios:
    - Happy path
    - Error conditions
    - Resource limits
    - Concurrent access

# Security
security:
  file_handling:
    - Validate all paths
    - Check permissions
    - Handle symlinks safely
  content:
    - Preserve sensitive business information
    - Maintain personnel references
    - Retain meeting context and decisions
    - Track organizational changes
    - Preserve historical context
    - Document business relationships
    - Maintain decision trails
    - Record system architecture details

# Performance
performance:
  async_operations:
    - File I/O
    - Image processing
    - PDF generation
  optimization:
    - Cache markdown-it results
    - Batch operations
    - Stream large files
    - Optimize image processing
    - Efficient PDF generation

# Logging
logging:
  required_fields:
    - timestamp
    - phase
    - file_path
    - operation
    - status
  levels:
    - DEBUG: Development details
    - INFO: Normal operations
    - WARNING: Non-critical issues
    - ERROR: Critical failures
  content_filtering:
    - filter_base64: true
    - max_binary_length: 100
    - binary_summary: "[BASE64 DATA: {size} {type}]"
    - excluded_patterns:
      - "[A-Za-z0-9+/]{100,}={0,2}"

# Configuration
configuration:
  sources:
    - Environment variables
    - .env file
    - CLI arguments
    - Default config
  validation:
    - Required fields
    - Type checking
    - Path existence
    - Value ranges
    - Plugin compatibility

# Development Workflow
workflow:
  version_control:
    - Use feature branches
    - Write clear commits
    - Update documentation
  review:
    - Code review required
    - Test coverage check
    - Documentation update
    - Performance impact

# Document Handling
document_handling:
  office_formats:
    - Word:
        extensions: [.docx, .doc]
        metadata: [author, title, created, modified]
        elements: [tables, images, headers, lists]
    - PowerPoint:
        extensions: [.pptx, .ppt]
        metadata: [slides, notes, speaker_notes]
        elements: [diagrams, charts, animations]
    - Excel:
        extensions: [.xlsx, .xls]
        metadata: [sheets, formulas, named_ranges]
        elements: [tables, charts, pivot_tables]
    - PDF:
        extensions: [.pdf]
        metadata: [title, author, keywords]
        elements: [text, images, forms]
  conversion:
    tool: markitdown
    preserve:
      - Document structure
      - Formatting
      - Tables
      - Lists
      - Images
      - Metadata

# Document Processing Configuration
document_processing:
  base_paths:
    input: "${NOVA_INPUT_DIR}"
    assets: "${NOVA_OFFICE_ASSETS_DIR}"
    temp: "${NOVA_OFFICE_TEMP_DIR}"
    
  embedded_documents:
    word:
      extensions: [.docx, .doc]
      processor: markitdown
      extract_images: true
      
    pdf:
      extensions: [.pdf]
      processor: pdf2md
      extract_text: true
      preview_support: true
      
    powerpoint:
      extensions: [.pptx, .ppt]
      processor: pptx2md
      extract_images: true
      
  error_handling:
    missing_file:
      level: warning
      action: continue
      template: |
        > **Warning**: Embedded document not found
        > - File: {filename}
        > - Path: {path}
        > Please ensure document exists in input directory
        
    processing_error:
      level: error
      action: retry
      max_retries: 3
      template: |
        > **Error**: Failed to process document
        > - File: {filename}
        > - Error: {error}
        > Processing failed after {retry_count} attempts
